#SQL[@1,N38]Result[]
drop database if exists fk_self_refer3;

#SQL[@2,N30]Result[]
create database fk_self_refer3;

#SQL[@3,N18]Result[]
use fk_self_refer3;

#SQL[@5,N23]Result[]
drop table if exists t1;

#SQL[@8,N328]Result[]
create table t1(a int, b int,
                c int,
                d int, e int,
                f int, g int,
                primary key (a,b),
                unique key (a,c),
                constraint `c1` foreign key fk1(d,e) references t1(a,b),
                constraint `c2` foreign key fk2(f,g) references t1(a,c)
);

#SQL[@17,N20]Result[23, 451]
show create table t1;
Table  ¦  Create Table
t1  ¦  CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` int NOT NULL,
  `c` int DEFAULT NULL,
  `d` int DEFAULT NULL,
  `e` int DEFAULT NULL,
  `f` int DEFAULT NULL,
  `g` int DEFAULT NULL,
  PRIMARY KEY (`a`,`b`),
  UNIQUE KEY `a` (`a`,`c`),
  CONSTRAINT `c1` FOREIGN KEY (`d`,`e`) REFERENCES `t1` (`a`,`b`) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT `c2` FOREIGN KEY (`f`,`g`) REFERENCES `t1` (`a`,`c`) ON DELETE RESTRICT ON UPDATE RESTRICT
)

#SQL[@20,N37]Result[]
insert into t1 values (1,2,1,1,2,1,1);

#SQL[@23,N37]Result[]
insert into t1 values (1,3,2,1,3,1,2);

#SQL[@26,N37]Error[64]
insert into t1 values (1,4,3,1,5,1,2);
Cannot add or update a child row: a foreign key constraint fails

#SQL[@29,N37]Error[64]
insert into t1 values (1,4,3,1,4,1,4);
Cannot add or update a child row: a foreign key constraint fails

#SQL[@32,N37]Result[]
insert into t1 values (1,4,3,1,4,1,3);

#SQL[@35,N31]Error[84]
update t1 set b = 5 where b = 4;
internal error: Cannot delete or update a parent row: a foreign key constraint fails

#SQL[@38,N31]Error[64]
update t1 set e = 5 where b = 4;
Cannot add or update a child row: a foreign key constraint fails

#SQL[@40,N34]Result[]
update t1 set e = NULL where b = 4;

#SQL[@46,N31]Result[]
update t1 set b = 5 where b = 4;

#SQL[@49,N31]Error[84]
update t1 set c = 4 where b = 5;
internal error: Cannot delete or update a parent row: a foreign key constraint fails

#SQL[@52,N31]Error[64]
update t1 set g = 4 where b = 5;
Cannot add or update a child row: a foreign key constraint fails

#SQL[@55,N31]Result[]
update t1 set g = 2 where b = 5;

#SQL[@61,N31]Result[]
update t1 set c = 4 where b = 5;

#SQL[@64,N26]Result[]
delete from t1 where b = 5;

#SQL[@67,N26]Error[84]
delete from t1 where b = 3;
internal error: Cannot delete or update a parent row: a foreign key constraint fails

#SQL[@69,N34]Result[]
update t1 set e = NULL where b = 3;

#SQL[@72,N26]Error[84]
delete from t1 where b = 3;
internal error: Cannot delete or update a parent row: a foreign key constraint fails

#SQL[@74,N34]Result[]
update t1 set g = NULL where b = 3;

#SQL[@77,N26]Result[]
delete from t1 where b = 3;

#SQL[@80,N26]Error[84]
delete from t1 where b = 2;
internal error: Cannot delete or update a parent row: a foreign key constraint fails

#SQL[@82,N34]Result[]
update t1 set e = NULL where b = 2;

#SQL[@85,N26]Error[84]
delete from t1 where b = 2;
internal error: Cannot delete or update a parent row: a foreign key constraint fails

#SQL[@87,N34]Result[]
update t1 set g = NULL where b = 2;

#SQL[@89,N26]Result[]
delete from t1 where b = 2;

#SQL[@91,N23]Result[8, 1]
select count(*) from t1;
count(*)
0

#SQL[@93,N23]Result[]
drop table if exists p1;

#SQL[@94,N66]Result[]
create table p1(
    pa int,
    pb int,
    primary key (pa,pb)
);

#SQL[@100,N23]Result[]
drop table if exists q2;

#SQL[@101,N62]Result[]
create table q2(
   qa int,
   qb int,
   unique key (qa,qb)
);

#SQL[@107,N23]Result[]
drop table if exists t1;

#SQL[@111,N538]Result[]
create table t1(a int, b int,
                c int,
                d int, e int,
                f int, g int,
                h int, i int,
                j int, k int,
                primary key (a,b),
                unique key (a,c),
                constraint `c1` foreign key fk1(d,e) references t1(a,b),
                constraint `c2` foreign key fk2(f,h) references t1(a,c),
                constraint `c3` foreign key fk3(h,i) references p1(pa,pb),
                constraint `c4` foreign key fk4(h,k) references q2(qa,qb)
);

#SQL[@124,N20]Result[23, 761]
show create table t1;
Table  ¦  Create Table
t1  ¦  CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` int NOT NULL,
  `c` int DEFAULT NULL,
  `d` int DEFAULT NULL,
  `e` int DEFAULT NULL,
  `f` int DEFAULT NULL,
  `g` int DEFAULT NULL,
  `h` int DEFAULT NULL,
  `i` int DEFAULT NULL,
  `j` int DEFAULT NULL,
  `k` int DEFAULT NULL,
  PRIMARY KEY (`a`,`b`),
  UNIQUE KEY `a` (`a`,`c`),
  CONSTRAINT `c1` FOREIGN KEY (`d`,`e`) REFERENCES `t1` (`a`,`b`) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT `c2` FOREIGN KEY (`f`,`h`) REFERENCES `t1` (`a`,`c`) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT `c3` FOREIGN KEY (`h`,`i`) REFERENCES `p1` (`pa`,`pb`) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT `c4` FOREIGN KEY (`h`,`k`) REFERENCES `q2` (`qa`,`qb`) ON DELETE RESTRICT ON UPDATE RESTRICT
)

#SQL[@127,N45]Error[80]
insert into t1 values (1,2,3,1,2,1,3,4,4,4,4);
internal error: Cannot add or update a child row: a foreign key constraint fails

#SQL[@129,N27]Result[]
insert into p1 values (4,4);

#SQL[@131,N27]Result[]
insert into q2 values (4,4);

#SQL[@134,N53]Result[]
insert into t1 values ( 1,2, 4, 1,2, 1,10, 4,4, 10,4);

#SQL[@137,N55]Result[]
insert into t1 values (1,3,3,1,2,1,10,NULL,NULL,NULL,4);

#SQL[@140,N201]Error[80]
insert into t1 values (
                              1,4,5,
                              1,3,
                              1,5,
                              5,5,
                              10,5);
internal error: Cannot add or update a child row: a foreign key constraint fails

#SQL[@147,N27]Result[]
insert into p1 values (5,5);

#SQL[@149,N27]Result[]
insert into q2 values (5,5);

#SQL[@152,N181]Result[]
insert into t1 values (
                          1,4,5,
                          1,3,
                          1,5,
                          5,5,
                          10,5);

#SQL[@163,N31]Result[]
update t1 set c = 6 where b = 3;

#SQL[@166,N34]Result[]
update t1 set c = NULL where b = 3;

#SQL[@169,N26]Error[84]
delete from t1 where c = 4;
internal error: Cannot delete or update a parent row: a foreign key constraint fails

#SQL[@172,N26]Error[84]
delete from t1 where c = 4;
internal error: Cannot delete or update a parent row: a foreign key constraint fails

#SQL[@175,N34]Result[]
update t1 set h = NULL where c = 4;

#SQL[@178,N26]Error[84]
delete from t1 where c = 4;
internal error: Cannot delete or update a parent row: a foreign key constraint fails

#SQL[@181,N34]Result[]
update t1 set d = NULL where c = 4;

#SQL[@184,N26]Error[84]
delete from t1 where c = 4;
internal error: Cannot delete or update a parent row: a foreign key constraint fails

#SQL[@187,N43]Result[]
update t1 set f = NULL,g = NULL where c = 4;

#SQL[@190,N26]Error[84]
delete from t1 where c = 4;
internal error: Cannot delete or update a parent row: a foreign key constraint fails

#SQL[@193,N54]Result[]
update t1 set i = NULL, j = NULL, k = NULL where c = 4;

#SQL[@196,N26]Error[84]
delete from t1 where c = 4;
internal error: Cannot delete or update a parent row: a foreign key constraint fails

#SQL[@199,N34]Result[]
update t1 set c = NULL where b = 2;

#SQL[@202,N26]Error[84]
delete from t1 where b = 2;
internal error: Cannot delete or update a parent row: a foreign key constraint fails

#SQL[@206,N23]Error[81]
drop table if exists p1;
internal error: can not drop table 'p1' referenced by some foreign key constraint

#SQL[@207,N92]Error[23]
create table t1(a int primary key,b int,constraint `c1` foreign key fk1(b) references t1(a));
table t1 already exists

#SQL[@208,N11]Result[24, 2, 2, 2]
show tables;
Tables_in_fk_self_refer3
p1
q2
t1

#SQL[@209,N20]Result[23, 761]
show create table t1;
Table  ¦  Create Table
t1  ¦  CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` int NOT NULL,
  `c` int DEFAULT NULL,
  `d` int DEFAULT NULL,
  `e` int DEFAULT NULL,
  `f` int DEFAULT NULL,
  `g` int DEFAULT NULL,
  `h` int DEFAULT NULL,
  `i` int DEFAULT NULL,
  `j` int DEFAULT NULL,
  `k` int DEFAULT NULL,
  PRIMARY KEY (`a`,`b`),
  UNIQUE KEY `a` (`a`,`c`),
  CONSTRAINT `c1` FOREIGN KEY (`d`,`e`) REFERENCES `t1` (`a`,`b`) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT `c2` FOREIGN KEY (`f`,`h`) REFERENCES `t1` (`a`,`c`) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT `c3` FOREIGN KEY (`h`,`i`) REFERENCES `p1` (`pa`,`pb`) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT `c4` FOREIGN KEY (`h`,`k`) REFERENCES `q2` (`qa`,`qb`) ON DELETE RESTRICT ON UPDATE RESTRICT
)

#SQL[@210,N27]Error[47]
insert into t1 values (1,1);
Column count doesn't match value count at row 1

#SQL[@211,N27]Error[47]
insert into t1 values (2,1);
Column count doesn't match value count at row 1

#SQL[@212,N27]Error[47]
insert into t1 values (3,2);
Column count doesn't match value count at row 1

#SQL[@215,N47]Result[]
delete A from t1 as A,  t1 as B where A.a = B.b;

#SQL[@218,N49]Result[]
delete A,B from t1 as A,  t1 as B where A.a = B.b;

#SQL[@221,N50]Result[]
update t1 as A,t1 as B set A.a = 4 where A.a = B.b;

#SQL[@224,N59]Result[]
update t1 as A,t1 as B set A.a = 4, B.b = 3 where A.a = B.b;

#SQL[@227,N59]Result[]
update t1 as A,t1 as B set A.a = 4, A.b = 3 where A.a = B.b;

#SQL[@230,N50]Result[]
update t1 as A,t1 as B set B.a = 4 where A.a = B.b;

#SQL[@233,N48]Result[]
update t1 as A,t1 as B set A.a = 4 where A.a = 3;

#SQL[@236,N51]Result[]
update t1 as A set A.a = 3, A.b = 3 where A.a = A.b;

#SQL[@239,N27]Error[47]
insert into t1 values (3,3);
Column count doesn't match value count at row 1

#SQL[@242,N63]Result[]
update t1 as A set A.a = 4, A.b = 4 where A.a = A.b and A.a = 3;

#SQL[@245,N63]Result[]
update t1 as A set A.b = 4, A.a = 4 where A.a = A.b and A.a = 3;

#SQL[@247,N23]Result[]
drop table if exists t1;

#SQL[@248,N38]Result[]
drop database if exists fk_self_refer3;

