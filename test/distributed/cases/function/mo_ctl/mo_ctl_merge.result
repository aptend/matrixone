#SQL[@1,N23]Result[]
drop table if exists t1;

#SQL[@3,N51]Result[]
create table t1(
a int primary key,
b varchar(10)
);

#SQL[@8,N50]Result[37, 61]
select mo_ctl('dn', 'inspect', 'merge switch off');
mo_ctl(dn, inspect, merge switch off)

msg: merge is disabled for table (*)

auto merge is disabled

#SQL[@9,N32]Result[]
insert into t1 values (100, 'a');

#SQL[@10,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@12,N32]Result[]
insert into t1 values (110, 'a');

#SQL[@13,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@15,N62]Result[49, 105]
select mo_ctl('cn', 'mergeobjects', 't:mo_ctl_merge.t1:small');
mo_ctl(cn, mergeobjects, t:mo_ctl_merge.t1:small)

fmerged success
0199ccd9-d808-7c13-a57d-e829089302f8_00000, rows 2, blks 1, osize 1.538KiB, csize 678B



#SQL[@17,N15]Result[8, 1]
select sleep(1);
sleep(1)
0

#SQL[@18,N60]Result[8, 1]
select rows_cnt from metadata_scan('mo_ctl_merge.t1', 'a') g;
rows_cnt
2

#SQL[@20,N32]Result[]
insert into t1 values (105, 'a');

#SQL[@21,N32]Result[]
insert into t1 values (115, 'a');

#SQL[@22,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@24,N32]Result[]
insert into t1 values (120, 'a');

#SQL[@25,N32]Result[]
insert into t1 values (125, 'a');

#SQL[@26,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@28,N64]Result[51, 105]
select mo_ctl('cn', 'mergeobjects', 't:mo_ctl_merge.t1:overlap');
mo_ctl(cn, mergeobjects, t:mo_ctl_merge.t1:overlap)

fmerged success
0199ccd9-e027-7119-a50b-66211f643566_00000, rows 4, blks 1, osize 1.604KiB, csize 695B



#SQL[@30,N15]Result[8, 1]
select sleep(1);
sleep(1)
0

#SQL[@31,N108]Result[60, 19, 19]
select rows_cnt, bit_cast(`min` as int), bit_cast(`max` as int) from metadata_scan('mo_ctl_merge.t1', 'a') g;
rows_cnt  ¦  bit_cast(min as int)  ¦  bit_cast(max as int)
2  ¦  120  ¦  125
4  ¦  100  ¦  115

#SQL[@32,N13]Result[]
drop table t1;

#SQL[@34,N39]Result[]
create table t1(
a int,
b varchar(10)
);

#SQL[@38,N32]Result[]
insert into t1 values (100, 'a');

#SQL[@39,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@41,N32]Result[]
insert into t1 values (110, 'a');

#SQL[@42,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@44,N62]Result[49, 104]
select mo_ctl('cn', 'mergeobjects', 't:mo_ctl_merge.t1:small');
mo_ctl(cn, mergeobjects, t:mo_ctl_merge.t1:small)

emerged success
0199ccd9-e84a-7b91-951f-2fbb9460c856_00000, rows 2, blks 1, osize 1.86KiB, csize 769B



#SQL[@46,N15]Result[8, 1]
select sleep(1);
sleep(1)
0

#SQL[@47,N60]Result[8, 1]
select rows_cnt from metadata_scan('mo_ctl_merge.t1', 'a') g;
rows_cnt
2

#SQL[@49,N32]Result[]
insert into t1 values (105, 'a');

#SQL[@50,N32]Result[]
insert into t1 values (115, 'a');

#SQL[@51,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@53,N32]Result[]
insert into t1 values (120, 'a');

#SQL[@54,N32]Result[]
insert into t1 values (125, 'a');

#SQL[@55,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@57,N64]Result[51, 105]
select mo_ctl('cn', 'mergeobjects', 't:mo_ctl_merge.t1:overlap');
mo_ctl(cn, mergeobjects, t:mo_ctl_merge.t1:overlap)

fmerged success
0199ccd9-f070-7054-9c3c-bd8620a1a924_00000, rows 6, blks 1, osize 2.001KiB, csize 803B



#SQL[@59,N15]Result[8, 1]
select sleep(1);
sleep(1)
0

#SQL[@60,N108]Result[60, 19]
select rows_cnt, bit_cast(`min` as int), bit_cast(`max` as int) from metadata_scan('mo_ctl_merge.t1', 'a') g;
rows_cnt  ¦  bit_cast(min as int)  ¦  bit_cast(max as int)
6  ¦  100  ¦  125

#SQL[@61,N13]Result[]
drop table t1;

#SQL[@62,N60]Result[]
create table t1(
a varchar(100) primary key,
b varchar(10)
);

#SQL[@66,N109]Result[]
insert into t1 values ('abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxya', 'b');

#SQL[@67,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@69,N109]Result[]
insert into t1 values ('abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz', 'b');

#SQL[@70,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@72,N62]Result[49, 105]
select mo_ctl('cn', 'mergeobjects', 't:mo_ctl_merge.t1:small');
mo_ctl(cn, mergeobjects, t:mo_ctl_merge.t1:small)

fmerged success
0199ccd9-f8a7-7da0-bea1-835e35f9bb8e_00000, rows 2, blks 1, osize 1.729KiB, csize 773B



#SQL[@74,N15]Result[8, 1]
select sleep(1);
sleep(1)
0

#SQL[@75,N60]Result[8, 1]
select rows_cnt from metadata_scan('mo_ctl_merge.t1', 'a') g;
rows_cnt
2

#SQL[@77,N109]Result[]
insert into t1 values ('abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyb', 'b');

#SQL[@78,N109]Result[]
insert into t1 values ('abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyc', 'b');

#SQL[@79,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@81,N109]Result[]
insert into t1 values ('abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxaa', 'b');

#SQL[@82,N109]Result[]
insert into t1 values ('abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxab', 'b');

#SQL[@83,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@85,N64]Result[51, 105]
select mo_ctl('cn', 'mergeobjects', 't:mo_ctl_merge.t1:overlap');
mo_ctl(cn, mergeobjects, t:mo_ctl_merge.t1:overlap)

fmerged success
0199ccda-00cc-70ca-aa40-7770852decbc_00000, rows 6, blks 1, osize 2.233KiB, csize 833B



#SQL[@87,N15]Result[8, 1]
select sleep(1);
sleep(1)
0

#SQL[@88,N70]Result[26, 73]
select rows_cnt, min, max from metadata_scan('mo_ctl_merge.t1', 'a') g;
rows_cnt  ¦  min  ¦  max
6  ¦  abcdefghijklmnopqrstuvwxyzabcd  ¦  abcdefghijklmnopqrstuvwxyzabce

#SQL[@89,N13]Result[]
drop table t1;

#SQL[@90,N51]Result[]
create table t1(
a int primary key,
b varchar(10)
);

#SQL[@94,N32]Result[]
insert into t1 values (105, 'a');

#SQL[@95,N32]Result[]
insert into t1 values (115, 'a');

#SQL[@96,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@98,N32]Result[]
insert into t1 values (110, 'a');

#SQL[@99,N32]Result[]
insert into t1 values (120, 'a');

#SQL[@100,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@102,N32]Result[]
insert into t1 values (116, 'a');

#SQL[@103,N32]Result[]
insert into t1 values (126, 'a');

#SQL[@104,N47]Result[34, 79]
select mo_ctl('dn', 'flush', 'mo_ctl_merge.t1');
mo_ctl(dn, flush, mo_ctl_merge.t1)
{
  "method": "Flush",
  "result": [
    {
      "returnStr": "OK"
    }
  ]
}


#SQL[@106,N67]Result[54, 105]
select mo_ctl('cn', 'mergeobjects', 't:mo_ctl_merge.t1:overlap(2)');
mo_ctl(cn, mergeobjects, t:mo_ctl_merge.t1:overlap(2))

fmerged success
0199ccda-0b14-77e9-87fe-a9e4e7e41c6e_00000, rows 4, blks 1, osize 1.604KiB, csize 695B



#SQL[@108,N15]Result[8, 1]
select sleep(1);
sleep(1)
0

#SQL[@109,N108]Result[60, 19, 19]
select rows_cnt, bit_cast(`min` as int), bit_cast(`max` as int) from metadata_scan('mo_ctl_merge.t1', 'a') g;
rows_cnt  ¦  bit_cast(min as int)  ¦  bit_cast(max as int)
2  ¦  116  ¦  126
4  ¦  105  ¦  120

#SQL[@110,N13]Result[]
drop table t1;

#SQL[@149,N49]Result[36, 59]
select mo_ctl('dn', 'inspect', 'merge switch on');
mo_ctl(dn, inspect, merge switch on)

msg: merge is enabled for table (*)

auto merge is enabled

#SQL[@150,N5]Result[]
begin;

#SQL[@151,N64]Error[74]
select mo_ctl('cn', 'mergeobjects', 't:mo_ctl_merge.p_table_01');
internal error: cannot execute MERGEOBJECTS within an explicit transaction

#SQL[@152,N7]Result[]
commit ;

